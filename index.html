<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rafal Cobra (Beta)</title>
  <!-- Firebase SDK (modo compat para simplicidade) -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
  <!-- Importa a fonte Lilita One do Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet">
  <style>
    /* Global: aplica a fonte em todos os elementos */
    *, *::before, *::after {
      box-sizing: border-box;
      font-family: 'Lilita One', cursive;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0;
      background: #000;
      height: 100vh;
    }
    /* Modal para registro de nickname */
    #nicknameModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      z-index: 1000;
      text-align: center;
      padding: 20px;
    }
    #nicknameModal input {
      padding: 10px;
      font-size: 3vh;
      border: none;
      border-radius: 5px;
      margin-top: 20px;
      text-align: center;
    }
    #nicknameModal button {
      padding: 10px 20px;
      font-size: 3vh;
      margin-top: 20px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    /* Container do jogo */
    #game-container {
      position: relative;
    }
    /* Os canvases ocuparão 100% do container */
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 10px;
      transition: opacity 1s ease;
    }
    #backgroundCanvas {
      z-index: 1;
      opacity: 1;
    }
    #gameCanvas {
      z-index: 2;
      opacity: 0;
    }
    /* Ao iniciar o jogo, alterna a opacidade */
    #game-container.playing #backgroundCanvas {
      opacity: 0;
    }
    #game-container.playing #gameCanvas {
      opacity: 1;
    }
    /* Placar */
    #scoreboard {
      position: absolute;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      color: #fff;
      font-size: 3vh;
      background: rgba(0,0,0,0.5);
      padding: 4px 8px;
      border-radius: 5px;
    }
    /* Tela de Game Over */
    #gameOverScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      color: #fff;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    #gameOverScreen h1 {
      font-size: 6vh;
      margin: 0;
    }
    #gameOverScreen p {
      font-size: 3vh;
      margin: 10px 0;
    }
    #gameOverScreen button {
      padding: 10px 20px;
      font-size: 3vh;
      margin-top: 20px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    /* Área de controles */
    #controls {
      display: flex;
      margin-top: 20px;
    }
    #controls button {
      margin: 0 5px;
      padding: 0.5em 1em;
      font-size: 2vh;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #controls button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    /* Tela de Leaderboard Global */
    #leaderboardScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      color: #fff;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }
    #leaderboardScreen h1 {
      font-size: 6vh;
      margin-bottom: 20px;
    }
    #leaderboardList {
      max-height: 50vh;
      overflow-y: auto;
      width: 80%;
      text-align: left;
      font-size: 3vh;
    }
    #leaderboardList p {
      margin: 5px 0;
    }
    #leaderboardScreen button {
      padding: 10px 20px;
      font-size: 3vh;
      margin-top: 20px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Modal para registro de nickname -->
  <div id="nicknameModal">
    <h2>Escolha seu nickname</h2>
    <input type="text" id="nicknameInput" placeholder="Digite seu nickname" />
    <button id="saveNicknameBtn">Salvar</button>
  </div>

  <!-- Área do jogo -->
  <div id="game-container">
    <div id="scoreboard">Score: <span id="score">0</span></div>
    <canvas id="backgroundCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    <div id="gameOverScreen">
      <h1>Game Over!</h1>
      <p>Score: <span id="finalScore"></span></p>
      <button id="gameOverRestartBtn">Restart</button>
    </div>
  </div>

  <!-- Controles -->
  <div id="controls">
    <button id="startBtn">Play</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="restartBtn" disabled>Restart</button>
    <button id="leaderboardBtn">LEADERBOARD</button>
  </div>

  <!-- Tela de Leaderboard Global -->
  <div id="leaderboardScreen">
    <h1>Leaderboard Mundial</h1>
    <div id="leaderboardList"></div>
    <button id="backToGameBtn">Voltar</button>
  </div>

  <script>
    // ============================================
    // 1. Configuração do Firebase (substitua com seus dados)
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyAduVj6Gv-XeAvDw8RkpzteIn46ciU0TV0",
      authDomain: "leaderboardrr.firebaseapp.com",
      databaseURL: "https://leaderboardrr-default-rtdb.firebaseio.com",
      projectId: "leaderboardrr",
      storageBucket: "leaderboardrr.firebasestorage.app",
      messagingSenderId: "187590049610",
      appId: "1:187590049610:web:41ccc3e36f69c757338bb3"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ============================================
    // 2. Reset do Leaderboard a cada nova versão
    // ============================================
    // Defina a versão atual do jogo.
    const currentGameVersion = "v2"; // Atualize esse valor para cada nova versão

    function checkAndResetLeaderboard() {
      const versionRef = database.ref("leaderboardVersion");
      versionRef.once("value")
        .then(snapshot => {
          const storedVersion = snapshot.val();
          if (storedVersion !== currentGameVersion) {
            // Se a versão armazenada for diferente, apaga os scores...
            database.ref("scores").remove()
              .then(() => {
                // ... e atualiza a versão para a atual.
                versionRef.set(currentGameVersion);
                console.log("Leaderboard resetado. Versão atual: " + currentGameVersion);
              })
              .catch(error => {
                console.error("Erro ao resetar o leaderboard:", error);
              });
          }
        })
        .catch(error => {
          console.error("Erro ao checar versão:", error);
        });
    }
    checkAndResetLeaderboard();

    // ============================================
    // 3. Registro de Nickname (único por navegador)
    // ============================================
    const nicknameModal = document.getElementById("nicknameModal");
    const nicknameInput = document.getElementById("nicknameInput");
    const saveNicknameBtn = document.getElementById("saveNicknameBtn");
    let playerNickname = localStorage.getItem("playerNickname");

    function checkNickname() {
      if (!playerNickname) {
        nicknameModal.style.display = "flex";
      } else {
        nicknameModal.style.display = "none";
      }
    }
    saveNicknameBtn.addEventListener("click", () => {
      const nick = nicknameInput.value.trim();
      if (nick !== "") {
        playerNickname = nick;
        localStorage.setItem("playerNickname", playerNickname);
        nicknameModal.style.display = "none";
      }
    });
    checkNickname();

    // ============================================
    // 4. Lógica do Jogo (Snake)
    // ============================================
    const bgCanvas = document.getElementById("backgroundCanvas");
    const bgCtx = bgCanvas.getContext("2d");
    const gameCanvas = document.getElementById("gameCanvas");
    const ctx = gameCanvas.getContext("2d");
    const container = document.getElementById("game-container");
    const gameOverScreen = document.getElementById("gameOverScreen");
    const finalScoreEl = document.getElementById("finalScore");
    let tileCount = 20;
    let snake = [];
    let velocity = { x: 0, y: 0 };
    let apple = { x: 0, y: 0 };
    let score = 0;
    let gameLoop = null;

    // Imagens do jogo
    const backgroundImg = new Image();
    backgroundImg.src = "https://media.discordapp.net/attachments/1310983426488274987/1373339971318054984/Screenshot_20250414_152127_Gallery.jpg?ex=6833f144&is=68329fc4&hm=5bd4dac3746af61cf5706444daccb5e8b93aeacb37ceea2830c29f1fac708914&=&format=webp&width=1260&height=756";
    const snakeImg = new Image();
    snakeImg.src = backgroundImg.src;
    const foodImg = new Image();
    foodImg.src = "https://media.discordapp.net/attachments/1326527256532746302/1375603066434228244/IMG_2161.png?ex=683443f0&is=6832f270&hm=5523cd4f5da5c5026d762309410ff13eaef4a20ec413e1166be81075af848853&=&format=webp&quality=lossless&width=908&height=912";

    function resizeCanvas() {
      const controls = document.getElementById("controls");
      const availableWidth = window.innerWidth;
      const availableHeight = window.innerHeight - controls.offsetHeight - 20;
      let newSize;
      if (document.fullscreenElement) {
        newSize = Math.min(window.innerWidth, window.innerHeight);
      } else {
        newSize = Math.floor(Math.min(availableWidth, availableHeight) * 0.9);
      }
      container.style.width = newSize + "px";
      container.style.height = newSize + "px";
      bgCanvas.width = newSize;
      bgCanvas.height = newSize;
      gameCanvas.width = newSize;
      gameCanvas.height = newSize;
      drawInitialBackground();
      drawGame();
    }
    window.addEventListener("resize", resizeCanvas);

    function drawInitialBackground() {
      bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
      bgCtx.drawImage(backgroundImg, 0, 0, bgCanvas.width, bgCanvas.height);
    }

    function placeApple() {
      apple.x = Math.floor(Math.random() * tileCount);
      apple.y = Math.floor(Math.random() * tileCount);
      if (snake.some(seg => seg.x === apple.x && seg.y === apple.y)) {
        placeApple();
      }
    }

    function collision(head) {
      return snake.slice(1).some(seg => seg.x === head.x && seg.y === head.y);
    }

    function drawGame() {
      let gridSize = gameCanvas.width / tileCount;
      ctx.fillStyle = "#888";
      ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
      
      // Desenha a maçã
      ctx.drawImage(foodImg, apple.x * gridSize, apple.y * gridSize, gridSize, gridSize);
      
      // Desenha a cobra
      snake.forEach(seg => {
        ctx.drawImage(snakeImg, seg.x * gridSize, seg.y * gridSize, gridSize, gridSize);
      });
    }

    function startGame() {
      gameOverScreen.style.display = "none";
      snake = [{ x: 10, y: 10 }];
      velocity = { x: 0, y: 0 };
      score = 0;
      document.getElementById("score").textContent = score;
      placeApple();
      drawInitialBackground();
      drawGame();
      container.classList.add("playing");
      document.getElementById("startBtn").disabled = true;
      document.getElementById("pauseBtn").disabled = false;
      document.getElementById("restartBtn").disabled = false;
    }

    function beginMovement(e) {
      const key = e.key;
      if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(key)) {
        if (velocity.x === 0 && velocity.y === 0) {
          switch(key) {
            case "ArrowUp": velocity = { x: 0, y: -1 }; break;
            case "ArrowDown": velocity = { x: 0, y: 1 }; break;
            case "ArrowLeft": velocity = { x: -1, y: 0 }; break;
            case "ArrowRight": velocity = { x: 1, y: 0 }; break;
          }
          document.addEventListener("keydown", changeDirection);
          gameLoop = setInterval(gameTick, 100);
        }
      }
    }

    function changeDirection(e) {
      const key = e.key;
      if (key === "ArrowUp" && velocity.y !== 1) velocity = { x: 0, y: -1 };
      if (key === "ArrowDown" && velocity.y !== -1) velocity = { x: 0, y: 1 };
      if (key === "ArrowLeft" && velocity.x !== 1) velocity = { x: -1, y: 0 };
      if (key === "ArrowRight" && velocity.x !== -1) velocity = { x: 1, y: 0 };
    }

    function gameTick() {
      const head = { x: snake[0].x + velocity.x, y: snake[0].y + velocity.y };
      snake.unshift(head);
      if (head.x === apple.x && head.y === apple.y) {
        score++;
        document.getElementById("score").textContent = score;
        placeApple();
      } else {
        snake.pop();
      }
      if (
        head.x < 0 ||
        head.x >= tileCount ||
        head.y < 0 ||
        head.y >= tileCount ||
        collision(head)
      ) {
        clearInterval(gameLoop);
        // Envia o score para o Firebase – usamos o nickname como chave para evitar duplicatas
        submitScoreToFirebase(playerNickname, score);
        document.getElementById("finalScore").textContent = score;
        gameOverScreen.style.display = "flex";
        document.getElementById("pauseBtn").disabled = true;
        return;
      }
      drawGame();
    }

    // ============================================
    // 5. Integração com Firebase para Leaderboard
    // Usamos o nickname como chave para atualizar a pontuação apenas se o novo score for maior.
    // ============================================
    function submitScoreToFirebase(nickname, score) {
      const userRef = database.ref("scores/" + nickname);
      userRef.once("value").then(snapshot => {
        const data = snapshot.val();
        if (!data || score > data.score) {
          userRef.set({
            nickname: nickname,
            score: score,
            timestamp: Date.now()
          });
        }
      });
    }

    function showLeaderboard() {
      container.style.display = "none";
      document.getElementById("controls").style.display = "none";
      leaderboardList.innerHTML = "";
      database.ref("scores").orderByChild("score").limitToLast(10)
        .once("value")
        .then(snapshot => {
          const scores = [];
          snapshot.forEach(child => {
            scores.push(child.val());
          });
          scores.sort((a, b) => b.score - a.score);
          if (scores.length === 0) {
            leaderboardList.innerHTML = "<p>Nenhum registro ainda.</p>";
          } else {
            scores.forEach((entry, index) => {
              leaderboardList.innerHTML += `<p>${index + 1}. ${entry.nickname} - ${entry.score}</p>`;
            });
          }
          leaderboardScreen.style.display = "flex";
        });
    }

    function backToGame() {
      leaderboardScreen.style.display = "none";
      container.style.display = "block";
      document.getElementById("controls").style.display = "flex";
    }

    // ============================================
    // 6. Eventos dos Botões
    // ============================================
    document.getElementById("startBtn").addEventListener("click", () => {
      resizeCanvas();
      startGame();
    });
    document.getElementById("pauseBtn").addEventListener("click", () => {
      if (gameLoop) {
        clearInterval(gameLoop);
        gameLoop = null;
      }
    });
    document.getElementById("restartBtn").addEventListener("click", startGame);
    document.getElementById("gameOverRestartBtn").addEventListener("click", startGame);

    const leaderboardBtn = document.getElementById("leaderboardBtn");
    const leaderboardScreen = document.getElementById("leaderboardScreen");
    const leaderboardList = document.getElementById("leaderboardList");
    const backToGameBtn = document.getElementById("backToGameBtn");
    leaderboardBtn.addEventListener("click", showLeaderboard);
    backToGameBtn.addEventListener("click", backToGame);

    document.addEventListener("keydown", beginMovement);
    backgroundImg.onload = () => {
      resizeCanvas();
    };
    // Garante que o canvas seja redimensionado
    resizeCanvas();
  </script>
</body>
</html>
